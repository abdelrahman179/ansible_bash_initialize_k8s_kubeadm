#---------------------------------------------------------------------
# HAProxy configuration for Kubernetes API server load balancing
# Simple configuration for master01 and master02
# Generated by Ansible for {{ inventory_hostname }}
# Date: {{ ansible_date_time.iso8601 }}
#---------------------------------------------------------------------

#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    log stdout local0
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

#---------------------------------------------------------------------
# Defaults
#---------------------------------------------------------------------
defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    retries 3
    timeout connect 10s
    timeout client 300s
    timeout server 300s
    timeout check 10s
    maxconn 3000

#---------------------------------------------------------------------
# Frontend for Kubernetes API Server (port 6443)
#---------------------------------------------------------------------
frontend kubernetes-apiserver-frontend
    bind *:6443
    mode tcp
    option tcplog
    default_backend kubernetes-apiserver-backend

#---------------------------------------------------------------------
# Backend for Kubernetes API Server - Master Nodes Only
#---------------------------------------------------------------------
backend kubernetes-apiserver-backend
    mode tcp
    balance roundrobin
    option tcp-check
    
    # Simple health check - just check if port is open
    option log-health-checks
    
{% for host in groups['masters'] %}
    server {{ hostvars[host]['inventory_hostname'] }} {{ hostvars[host]['ansible_host'] }}:6443 check inter 10s fall 3 rise 2
{% endfor %}

#---------------------------------------------------------------------
# HAProxy Statistics Interface (optional)
#---------------------------------------------------------------------
frontend stats-frontend
    bind *:8404
    mode http
    option httplog
    stats enable
    stats uri /stats
    stats refresh 30s
    stats realm HAProxy\ Statistics
    stats auth admin:admin123
